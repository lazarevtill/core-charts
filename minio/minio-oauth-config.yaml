---
# MinIO OpenID Connect Configuration for Google OAuth
# This ConfigMap configures MinIO to use Google OAuth for authentication
apiVersion: v1
kind: ConfigMap
metadata:
  name: minio-oidc-config
  namespace: minio
data:
  # OpenID Connect configuration
  MINIO_IDENTITY_OPENID_CONFIG_URL: "https://accounts.google.com/.well-known/openid-configuration"
  MINIO_IDENTITY_OPENID_DISPLAY_NAME: "Google"
  MINIO_IDENTITY_OPENID_SCOPES: "openid,profile,email"
  MINIO_IDENTITY_OPENID_REDIRECT_URI: "https://s3-admin.theedgestory.org/oauth_callback"
  MINIO_IDENTITY_OPENID_CLAIM_NAME: "email"
  MINIO_IDENTITY_OPENID_CLAIM_PREFIX: ""
  MINIO_BROWSER_REDIRECT_URL: "https://s3-admin.theedgestory.org"

---
# MinIO Tenant patch to enable OAuth
# Apply with: kubectl patch tenant minio-tenant -n minio --type=merge -p "$(cat minio-oauth-config.yaml)"
apiVersion: minio.min.io/v2
kind: Tenant
metadata:
  name: minio-tenant
  namespace: minio
spec:
  # Add OpenID configuration to MinIO environment
  configuration:
    name: minio-config
  env:
    - name: MINIO_IDENTITY_OPENID_CONFIG_URL
      value: "https://accounts.google.com/.well-known/openid-configuration"
    - name: MINIO_IDENTITY_OPENID_CLIENT_ID
      valueFrom:
        secretKeyRef:
          name: google-oauth
          key: client-id
    - name: MINIO_IDENTITY_OPENID_CLIENT_SECRET
      valueFrom:
        secretKeyRef:
          name: google-oauth
          key: client-secret
    - name: MINIO_IDENTITY_OPENID_DISPLAY_NAME
      value: "Login with Google"
    - name: MINIO_IDENTITY_OPENID_SCOPES
      value: "openid,profile,email"
    - name: MINIO_IDENTITY_OPENID_REDIRECT_URI
      value: "https://s3-admin.theedgestory.org/oauth_callback"
    - name: MINIO_IDENTITY_OPENID_CLAIM_NAME
      value: "email"
    - name: MINIO_IDENTITY_OPENID_CLAIM_PREFIX
      value: ""
    - name: MINIO_BROWSER_REDIRECT_URL
      value: "https://s3-admin.theedgestory.org"

---
# MinIO Policy for OAuth users
# This creates a policy that grants admin access to users authenticated via OAuth
apiVersion: v1
kind: ConfigMap
metadata:
  name: minio-oauth-policy
  namespace: minio
data:
  oauth-admin-policy.json: |
    {
      "Version": "2012-10-17",
      "Statement": [
        {
          "Effect": "Allow",
          "Action": [
            "s3:*"
          ],
          "Resource": [
            "arn:aws:s3:::*"
          ]
        },
        {
          "Effect": "Allow",
          "Action": [
            "admin:*"
          ]
        }
      ]
    }
