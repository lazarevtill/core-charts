---
apiVersion: v1
kind: ConfigMap
metadata:
  name: deployment-tracker-script
  namespace: monitoring
data:
  deployment-tracker.py: |
    #!/usr/bin/env python3
    """
    Deployment Tracker for Grafana Annotations
    Watches Kubernetes deployments and posts annotations to Grafana
    """

    import os
    import time
    import requests
    from datetime import datetime
    from kubernetes import client, config, watch

    # Configuration
    GRAFANA_URL = os.getenv('GRAFANA_URL', 'http://grafana.monitoring.svc.cluster.local:3000')
    GRAFANA_USER = os.getenv('GRAFANA_USER', 'admin')
    GRAFANA_PASSWORD = os.getenv('GRAFANA_PASSWORD', 'admin123')
    GITHUB_TOKEN = os.getenv('GITHUB_TOKEN', '')  # Optional for higher rate limits
    GITHUB_REPO = 'uz0/core-pipeline'
    NAMESPACES = ['core-pipeline-production', 'core-pipeline-test']

    # Grafana dashboard UID where annotations should appear
    DASHBOARD_UID = 'core-pipeline-red'

    def get_latest_commit_info():
        """Fetch latest commit info from GitHub API"""
        url = f'https://api.github.com/repos/{GITHUB_REPO}/commits/main'
        headers = {}
        if GITHUB_TOKEN:
            headers['Authorization'] = f'token {GITHUB_TOKEN}'

        try:
            response = requests.get(url, headers=headers, timeout=10)
            response.raise_for_status()
            commit_data = response.json()

            return {
                'sha': commit_data['sha'][:7],
                'full_sha': commit_data['sha'],
                'message': commit_data['commit']['message'].split('\n')[0],
                'author': commit_data['commit']['author']['name'],
                'url': commit_data['html_url'],
                'date': commit_data['commit']['author']['date']
            }
        except Exception as e:
            print(f"Error fetching commit info: {e}")
            return None

    def post_grafana_annotation(text, tags, timestamp=None):
        """Post annotation to Grafana"""
        if timestamp is None:
            timestamp = int(time.time() * 1000)

        annotation = {
            'dashboardUID': DASHBOARD_UID,
            'time': timestamp,
            'tags': tags,
            'text': text
        }

        url = f'{GRAFANA_URL}/api/annotations'

        try:
            response = requests.post(
                url,
                json=annotation,
                auth=(GRAFANA_USER, GRAFANA_PASSWORD),
                timeout=10
            )
            response.raise_for_status()
            print(f"‚úÖ Posted annotation: {text}")
            return True
        except Exception as e:
            print(f"‚ùå Error posting annotation: {e}")
            return False

    def watch_deployments():
        """Watch for new pod deployments"""
        # Load Kubernetes config
        try:
            config.load_incluster_config()
        except:
            config.load_kube_config()

        v1 = client.CoreV1Api()
        w = watch.Watch()

        print(f"üëÄ Watching deployments in namespaces: {NAMESPACES}")

        # Track seen pods to avoid duplicates
        seen_pods = set()

        for namespace in NAMESPACES:
            try:
                # Get existing pods first
                pods = v1.list_namespaced_pod(namespace, label_selector='app=kuberoapp')
                for pod in pods.items:
                    seen_pods.add(pod.metadata.uid)
            except Exception as e:
                print(f"Error listing pods in {namespace}: {e}")

        # Watch for new pods
        while True:
            try:
                for namespace in NAMESPACES:
                    for event in w.stream(
                        v1.list_namespaced_pod,
                        namespace=namespace,
                        label_selector='app=kuberoapp',
                        timeout_seconds=30
                    ):
                        pod = event['object']
                        event_type = event['type']

                        # Only process ADDED events for new pods
                        if event_type == 'ADDED' and pod.metadata.uid not in seen_pods:
                            seen_pods.add(pod.metadata.uid)

                            # Wait a bit for pod to start
                            time.sleep(2)

                            # Get commit info
                            commit_info = get_latest_commit_info()

                            if commit_info:
                                env = 'production' if 'production' in namespace else 'development'

                                text = f"""**Deployment: {env}**
    Commit: [{commit_info['sha']}]({commit_info['url']})
    Message: {commit_info['message']}
    Author: {commit_info['author']}
    Pod: {pod.metadata.name}"""

                                tags = ['deployment', env, commit_info['sha']]

                                timestamp = int(datetime.now().timestamp() * 1000)
                                post_grafana_annotation(text, tags, timestamp)

                            print(f"üì¶ New deployment detected: {pod.metadata.name} in {namespace}")

            except Exception as e:
                print(f"Error in watch loop: {e}")
                time.sleep(5)
                continue

    if __name__ == '__main__':
        print("üöÄ Starting Deployment Tracker...")
        watch_deployments()

---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: deployment-tracker
  namespace: monitoring

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: deployment-tracker
rules:
- apiGroups: [""]
  resources:
  - pods
  verbs: ["get", "list", "watch"]
- apiGroups: ["apps"]
  resources:
  - deployments
  - replicasets
  verbs: ["get", "list", "watch"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: deployment-tracker
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: deployment-tracker
subjects:
- kind: ServiceAccount
  name: deployment-tracker
  namespace: monitoring

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: deployment-tracker
  namespace: monitoring
spec:
  replicas: 1
  selector:
    matchLabels:
      app: deployment-tracker
  template:
    metadata:
      labels:
        app: deployment-tracker
    spec:
      serviceAccountName: deployment-tracker
      containers:
      - name: tracker
        image: python:3.11-slim
        command:
          - /bin/bash
          - -c
          - |
            pip install --no-cache-dir kubernetes==28.1.0 requests==2.31.0 && \
            python3 -u /app/deployment-tracker.py
        env:
        - name: GRAFANA_URL
          value: "http://grafana.monitoring.svc.cluster.local:3000"
        - name: GRAFANA_USER
          value: "admin"
        - name: GRAFANA_PASSWORD
          value: "admin123"
        - name: GITHUB_TOKEN
          value: ""  # Optional: Add GitHub token for higher API rate limits
        volumeMounts:
        - name: script
          mountPath: /app
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "200m"
      volumes:
      - name: script
        configMap:
          name: deployment-tracker-script
          defaultMode: 0755
