apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "postgresql-init.fullname" . }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "postgresql-init.labels" . | nindent 4 }}
data:
  init.sh: |
    #!/bin/bash
    set -e

    echo "Starting PostgreSQL initialization..."
    echo "Connecting to: ${PGHOST}:${PGPORT}"

    # Wait for PostgreSQL to be ready
    until pg_isready -h ${PGHOST} -p ${PGPORT} -U ${PGUSER}; do
      echo "Waiting for PostgreSQL to be ready..."
      sleep 2
    done

    echo "PostgreSQL is ready. Starting database initialization..."

    {{- range .Values.databases }}
    echo "----------------------------------------"
    echo "Creating database: {{ .name }}"
    echo "Creating user: {{ .user }}"

    # Create database if it doesn't exist
    psql -v ON_ERROR_STOP=1 --username "${PGUSER}" --dbname postgres <<-EOSQL
      SELECT 'CREATE DATABASE {{ .name }}'
      WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = '{{ .name }}')
      \gexec

      DO \$\$
      BEGIN
        IF NOT EXISTS (SELECT FROM pg_catalog.pg_roles WHERE rolname = '{{ .user }}') THEN
          CREATE ROLE {{ .user }} WITH LOGIN PASSWORD '{{ .password }}';
        END IF;
      END
      \$\$;

      GRANT ALL PRIVILEGES ON DATABASE {{ .name }} TO {{ .user }};
      ALTER DATABASE {{ .name }} OWNER TO {{ .user }};
    EOSQL

    # Connect to the database and set permissions
    psql -v ON_ERROR_STOP=1 --username "${PGUSER}" --dbname {{ .name }} <<-EOSQL
      GRANT ALL ON SCHEMA public TO {{ .user }};
      ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON TABLES TO {{ .user }};
      ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON SEQUENCES TO {{ .user }};
      ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON FUNCTIONS TO {{ .user }};
    EOSQL

    echo "âœ“ Database {{ .name }} initialized successfully"
    {{- end }}

    echo "----------------------------------------"
    echo "All databases initialized successfully!"
