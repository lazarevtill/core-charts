authentik:
  # Global Authentik configuration
  global:
    env:
      # Global settings
      - name: AUTHENTIK_SECRET_KEY
        value: "authentik-secret-key-change-me-2024"  # TODO: Generate secure secret
      - name: AUTHENTIK_ERROR_REPORTING__ENABLED
        value: "false"
      - name: AUTHENTIK_DISABLE_UPDATE_CHECK
        value: "true"
      - name: AUTHENTIK_DISABLE_STARTUP_ANALYTICS
        value: "true"
      - name: AUTHENTIK_AVATARS
        value: "gravatar"
      # Cookie and domain settings for proper HTTPS handling
      # Use dot prefix to allow all subdomains
      - name: AUTHENTIK_COOKIE_DOMAIN
        value: ".theedgestory.org"
      # External URL configuration
      - name: AUTHENTIK_HOST
        value: "https://auth.theedgestory.org"
      # Trust proxy headers from nginx/cloudflare
      - name: AUTHENTIK_USE_X_FORWARDED_FOR
        value: "true"
      - name: AUTHENTIK_USE_X_FORWARDED_PROTO
        value: "true"
      - name: AUTHENTIK_USE_X_FORWARDED_PORT
        value: "true"
      # CSRF trusted origins - wildcard for all subdomains
      - name: AUTHENTIK_CSRF_TRUSTED_ORIGINS
        value: "https://auth.theedgestory.org,https://*.theedgestory.org,http://authentik-server.authentik.svc.cluster.local"
      # Additional CSRF and cookie settings for proper operation
      - name: AUTHENTIK_CSRF_COOKIE_SECURE
        value: "true"
      - name: AUTHENTIK_CSRF_COOKIE_SAMESITE
        value: "Lax"
      - name: AUTHENTIK_SESSION_COOKIE_DOMAIN
        value: ".theedgestory.org"
      - name: DJANGO_ALLOWED_HOSTS
        value: "*"
      # External PostgreSQL connection
      - name: AUTHENTIK_POSTGRESQL__HOST
        value: "10.42.0.86"
      - name: AUTHENTIK_POSTGRESQL__PORT
        value: "5432"
      - name: AUTHENTIK_POSTGRESQL__NAME
        value: "authentik"
      - name: AUTHENTIK_POSTGRESQL__USER
        value: "authentik_user"
      - name: AUTHENTIK_POSTGRESQL__PASSWORD
        valueFrom:
          secretKeyRef:
            name: authentik-postgresql
            key: password

    envFrom:
      # External Redis connection
      - secretRef:
          name: authentik-redis

  # PostgreSQL Configuration (use existing PostgreSQL)
  postgresql:
    enabled: false

  # Redis Configuration (use existing Redis)
  redis:
    enabled: false

  # Server configuration
  server:
    replicas: 1

    ingress:
      enabled: true
      ingressClassName: nginx
      annotations:
        cert-manager.io/cluster-issuer: "letsencrypt-prod"
        nginx.ingress.kubernetes.io/force-ssl-redirect: "false"
        nginx.ingress.kubernetes.io/configuration-snippet: |
          proxy_set_header X-Forwarded-Proto https;
          proxy_set_header X-Forwarded-Ssl on;
          proxy_set_header X-Forwarded-Port 443;
      hosts:
        - auth.theedgestory.org
      tls:
        - secretName: authentik-tls
          hosts:
            - auth.theedgestory.org

    resources:
      requests:
        cpu: 250m
        memory: 1Gi
      limits:
        cpu: 1000m
        memory: 2Gi

  # Worker configuration
  worker:
    replicas: 1

    resources:
      requests:
        cpu: 250m
        memory: 512Mi
      limits:
        cpu: 1000m
        memory: 1Gi

  # Bootstrap configuration
  bootstrap:
    enabled: true
    email: "dcversus@gmail.com"
    password: "authentik-admin-password-2024"  # Initial admin password
    token: "authentik-bootstrap-token-2024"
