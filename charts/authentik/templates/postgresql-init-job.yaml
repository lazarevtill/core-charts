apiVersion: batch/v1
kind: Job
metadata:
  name: authentik-postgresql-init
  namespace: {{ .Release.Namespace }}
spec:
  template:
    spec:
      restartPolicy: OnFailure
      containers:
      - name: postgresql-init
        image: postgres:16
        command:
          - /bin/bash
          - -c
          - |
            export PGPASSWORD="${POSTGRES_PASSWORD}"

            # Wait for PostgreSQL to be ready
            until psql -h "${POSTGRES_HOST}" -U "${POSTGRES_USER}" -d postgres -c '\q' 2>/dev/null; do
              echo "Waiting for PostgreSQL..."
              sleep 2
            done

            # Create user if not exists
            psql -h "${POSTGRES_HOST}" -U "${POSTGRES_USER}" -d postgres <<-EOSQL
              DO \$\$
              BEGIN
                IF NOT EXISTS (SELECT FROM pg_catalog.pg_roles WHERE rolname = 'authentik_user') THEN
                  CREATE ROLE authentik_user WITH LOGIN PASSWORD '${AUTHENTIK_PASSWORD}';
                END IF;
              END
              \$\$;
            EOSQL

            # Create database if not exists
            psql -h "${POSTGRES_HOST}" -U "${POSTGRES_USER}" -d postgres <<-EOSQL
              SELECT 'CREATE DATABASE authentik OWNER authentik_user'
              WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = 'authentik')\gexec
            EOSQL

            # Grant permissions
            psql -h "${POSTGRES_HOST}" -U "${POSTGRES_USER}" -d postgres <<-EOSQL
              GRANT ALL PRIVILEGES ON DATABASE authentik TO authentik_user;
            EOSQL

            echo "Authentik database initialized successfully"
        env:
          - name: POSTGRES_HOST
            value: "infrastructure-postgresql.infrastructure.svc.cluster.local"
          - name: POSTGRES_USER
            value: "postgres"
          - name: POSTGRES_PASSWORD
            valueFrom:
              secretKeyRef:
                name: infrastructure-postgresql
                key: postgres-password
          - name: AUTHENTIK_PASSWORD
            valueFrom:
              secretKeyRef:
                name: authentik-postgresql
                key: password
