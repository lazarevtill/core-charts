{{- $redisPassword := .Values.redis.auth.password | default (randAlphaNum 32) }}
{{- range .Values.environments }}
---
apiVersion: v1
kind: Secret
metadata:
  name: redis-{{ .name }}-secret
  namespace: {{ $.Release.Namespace }}
  labels:
    app: redis
    environment: {{ .name }}
  annotations:
    "helm.sh/resource-policy": keep
type: Opaque
data:
  REDIS_HOST: {{ printf "%s-redis-master.%s.svc.cluster.local" $.Release.Name $.Release.Namespace | b64enc }}
  REDIS_PORT: {{ "6379" | b64enc }}
  REDIS_PASSWORD: {{ $redisPassword | b64enc }}
  # Connection string format
  REDIS_URL: {{ printf "redis://:%s@%s-redis-master.%s.svc.cluster.local:6379" $redisPassword $.Release.Name $.Release.Namespace | b64enc }}
{{- end }}
---
# Redis master password secret for the Redis chart itself
apiVersion: v1
kind: Secret
metadata:
  name: {{ .Release.Name }}-redis
  namespace: {{ $.Release.Namespace }}
  labels:
    app: redis
    role: master
  annotations:
    "helm.sh/resource-policy": keep
type: Opaque
data:
  redis-password: {{ $redisPassword | b64enc }}