{{- range .Values.environments }}
{{- $redisPassword := randAlphaNum 32 }}
---
apiVersion: v1
kind: Secret
metadata:
  name: redis-{{ .name }}-secret
  namespace: {{ $.Release.Namespace }}
  labels:
    app: redis
    environment: {{ .name }}
type: Opaque
data:
  REDIS_HOST: {{ printf "%s-redis-master.%s.svc.cluster.local" $.Release.Name $.Release.Namespace | b64enc }}
  REDIS_PORT: {{ "6379" | b64enc }}
  REDIS_PASSWORD: {{ $redisPassword | b64enc }}
  REDIS_USERNAME: {{ printf "redis_%s_user" .name | b64enc }}
  # Connection string format with username
  REDIS_URL: {{ printf "redis://redis_%s_user:%s@%s-redis-master.%s.svc.cluster.local:6379" .name $redisPassword $.Release.Name $.Release.Namespace | b64enc }}
{{- end }}
---
# Redis master password secret for the Redis chart itself
# This is the admin password for Redis server
apiVersion: v1
kind: Secret
metadata:
  name: {{ .Release.Name }}-redis
  namespace: {{ .Release.Namespace }}
  labels:
    app: redis
    role: master
type: Opaque
data:
  redis-password: {{ randAlphaNum 32 | b64enc }}
