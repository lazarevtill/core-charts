apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Release.Name }}-postgresql-init
  namespace: {{ $.Release.Namespace }}
  labels:
    app: postgresql
    role: init-scripts
data:
  01-init-databases.sh: |
    #!/bin/bash
    set -e

    echo "Creating databases and users..."

    {{- range .Values.databases }}
    # Read password from mounted secret
    PASSWORD_FILE="/secrets/{{ .name | replace "_" "-" }}/password"

    if [ -f "$PASSWORD_FILE" ]; then
      PASSWORD=$(cat "$PASSWORD_FILE")
    else
      echo "Warning: Password file not found for {{ .name }}, generating one"
      PASSWORD=$(openssl rand -base64 24 | tr -d "=+/" | cut -c1-24)
    fi

    # Create user and database for {{ .name }}
    PGPASSWORD=$POSTGRES_PASSWORD psql -v ON_ERROR_STOP=1 --username "$POSTGRES_USER" <<-EOSQL
      -- Check if user exists before creating
      DO \$\$
      BEGIN
        IF NOT EXISTS (SELECT FROM pg_user WHERE usename = '{{ .user }}') THEN
          CREATE USER {{ .user }} WITH PASSWORD '$PASSWORD';
        ELSE
          ALTER USER {{ .user }} WITH PASSWORD '$PASSWORD';
        END IF;
      END
      \$\$;

      -- Create database if not exists
      SELECT 'CREATE DATABASE {{ .name }} OWNER {{ .user }}'
      WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = '{{ .name }}') \gexec

      -- Grant privileges
      GRANT ALL PRIVILEGES ON DATABASE {{ .name }} TO {{ .user }};
    EOSQL

    echo "Created database {{ .name }} and user {{ .user }}"
    {{- end }}

    echo "Database initialization completed"