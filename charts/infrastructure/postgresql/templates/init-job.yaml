apiVersion: batch/v1
kind: Job
metadata:
  name: {{ .Release.Name }}-db-init
  namespace: {{ .Release.Namespace }}
  labels:
    app: postgresql
    role: init
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "5"
    "helm.sh/hook-delete-policy": before-hook-creation
spec:
  ttlSecondsAfterFinished: 300
  template:
    metadata:
      labels:
        app: postgresql-init
    spec:
      restartPolicy: OnFailure
      serviceAccountName: {{ .Release.Name }}-db-init
      containers:
      - name: init-databases
        image: docker.io/bitnamilegacy/postgresql:16.4.0-debian-12-r13
        command:
        - /bin/bash
        - -c
        - |
          set -e

          # Wait for PostgreSQL to be ready
          echo "Waiting for PostgreSQL..."
          until PGPASSWORD=$POSTGRES_ADMIN_PASSWORD psql -h {{ .Release.Name }}-postgresql.{{ .Release.Namespace }}.svc.cluster.local -U postgres -c '\l' > /dev/null 2>&1; do
            echo "PostgreSQL not ready, waiting..."
            sleep 2
          done
          echo "PostgreSQL is ready!"

          {{- range .Values.databases }}
          echo "Processing database {{ .name }}..."

          # Get password from secret
          DB_PASSWORD=$(cat /secrets/{{ .name | replace "_" "-" }}/DB_PASSWORD)

          # Create user and database
          PGPASSWORD=$POSTGRES_ADMIN_PASSWORD psql -h {{ $.Release.Name }}-postgresql.{{ $.Release.Namespace }}.svc.cluster.local -U postgres -v ON_ERROR_STOP=1 <<-EOSQL
            -- Create or update user
            DO \$\$
            BEGIN
              IF NOT EXISTS (SELECT FROM pg_user WHERE usename = '{{ .user }}') THEN
                CREATE USER {{ .user }} WITH PASSWORD '$DB_PASSWORD';
                RAISE NOTICE 'Created user {{ .user }}';
              ELSE
                ALTER USER {{ .user }} WITH PASSWORD '$DB_PASSWORD';
                RAISE NOTICE 'Updated password for user {{ .user }}';
              END IF;
            END
            \$\$;

            -- Create database if not exists
            SELECT 'CREATE DATABASE {{ .name }} OWNER {{ .user }}'
            WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = '{{ .name }}') \gexec

            -- Grant privileges
            GRANT ALL PRIVILEGES ON DATABASE {{ .name }} TO {{ .user }};

            -- Connect to the database and grant schema privileges
            \c {{ .name }}
            GRANT ALL ON SCHEMA public TO {{ .user }};
            ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON TABLES TO {{ .user }};
            ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON SEQUENCES TO {{ .user }};
          EOSQL

          echo "âœ“ Database {{ .name }} and user {{ .user }} configured"
          {{- end }}

          echo "Database initialization completed successfully!"
        env:
        - name: POSTGRES_ADMIN_PASSWORD
          valueFrom:
            secretKeyRef:
              name: {{ .Release.Name }}-postgresql
              key: postgres-password
        volumeMounts:
        {{- range .Values.databases }}
        - name: {{ .name | replace "_" "-" }}-secret
          mountPath: /secrets/{{ .name | replace "_" "-" }}
          readOnly: true
        {{- end }}
      volumes:
      {{- range .Values.databases }}
      - name: {{ .name | replace "_" "-" }}-secret
        secret:
          secretName: postgres-{{ .name | replace "_" "-" }}-secret
          items:
          - key: DB_PASSWORD
            path: DB_PASSWORD
      {{- end }}
