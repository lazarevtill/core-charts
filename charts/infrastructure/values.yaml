# Shared Infrastructure Configuration for The Edge Story
# Single shared PostgreSQL, Redis, and Kafka with credential isolation

# PostgreSQL (Bitnami)
postgresql:
  enabled: false
  auth:
    username: postgres
    password: "CHANGE_ME_postgres_password"
    database: postgres

  primary:
    resources:
      requests:
        memory: 256Mi
        cpu: 250m
      limits:
        memory: 512Mi
        cpu: 500m

    persistence:
      enabled: true
      size: 10Gi
      storageClass: local-path

    initdb:
      scripts:
        init.sql: |
          -- Create databases for dev and prod environments
          CREATE DATABASE core_dev;
          CREATE DATABASE core_prod;

          -- Create users with environment-specific credentials
          CREATE USER core_dev_user WITH PASSWORD 'CHANGE_ME_core_dev_password';
          CREATE USER core_prod_user WITH PASSWORD 'CHANGE_ME_core_prod_password';

          -- Grant database ownership
          GRANT ALL PRIVILEGES ON DATABASE core_dev TO core_dev_user;
          GRANT ALL PRIVILEGES ON DATABASE core_prod TO core_prod_user;

          -- Connect to core_dev and grant schema permissions
          \c core_dev
          GRANT ALL ON SCHEMA public TO core_dev_user;
          ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON TABLES TO core_dev_user;
          ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON SEQUENCES TO core_dev_user;

          -- Connect to core_prod and grant schema permissions
          \c core_prod
          GRANT ALL ON SCHEMA public TO core_prod_user;
          ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON TABLES TO core_prod_user;
          ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON SEQUENCES TO core_prod_user;

# Redis (Bitnami)
redis:
  enabled: false
  architecture: standalone
  auth:
    enabled: true
    password: "CHANGE_ME_redis_password"

  master:
    resources:
      requests:
        memory: 128Mi
        cpu: 100m
      limits:
        memory: 256Mi
        cpu: 250m

    persistence:
      enabled: true
      size: 2Gi
      storageClass: local-path

  commonConfiguration: |-
    maxmemory 256mb
    maxmemory-policy allkeys-lru
    appendonly yes

# Kafka (Bitnami)
# NOTE: Temporarily disabled - Bitnami changed their image strategy in 2025
# Will use Strimzi operator instead for Kafka
kafka:
  enabled: false

  resources:
    requests:
      memory: 512Mi
      cpu: 250m
    limits:
      memory: 1Gi
      cpu: 500m

  persistence:
    enabled: false
    size: 8Gi
    storageClass: local-path

  zookeeper:
    enabled: true
    replicaCount: 1
    resources:
      requests:
        memory: 256Mi
        cpu: 100m
      limits:
        memory: 512Mi
        cpu: 250m
    persistence:
      enabled: false
      size: 2Gi
      storageClass: local-path

  # Kafka configuration
  extraEnvVars:
    - name: KAFKA_CFG_AUTO_CREATE_TOPICS_ENABLE
      value: "true"

# Kafka UI - Web interface for Kafka management
kafkaUI:
  enabled: true

  image:
    repository: ghcr.io/kafbat/kafka-ui
    tag: latest

  resources:
    requests:
      memory: 256Mi
      cpu: 100m
    limits:
      memory: 512Mi
      cpu: 250m

  kafka:
    clusterName: "kafka-cluster"
    bootstrapServers: "kafka-cluster-kafka-bootstrap.infrastructure.svc.cluster.local:9092"

  # Google OAuth2 SSO Configuration (Layer 2 - Application Level)
  # IMPORTANT: OAuth2 credentials are stored in Kubernetes Secret (kafka-ui-oauth2-secret)
  # Secret must be created manually on the cluster (not committed to Git for security)
  oauth2:
    # Public configuration (safe to commit)
    scope: "openid,profile,email"
    redirectUri: "https://kafka.theedgestory.org/login/oauth2/code/google"
    # CRITICAL: Only allow dcversus@gmail.com (regex pattern)
    allowedEmailPattern: "^dcversus@gmail\\.com$"

    # Secret reference (actual credentials stored in Kubernetes Secret)
    existingSecret: "kafka-ui-oauth2-secret"

  ingress:
    host: "kafka.theedgestory.org"

# Cloudflare Tunnel - Zero-trust networking (disabled by default)
# Run setup-cloudflare-tunnel.sh to create tunnel and enable
cloudflared:
  enabled: true
  tunnelId: "6c01bbbf-3488-4182-b17b-3ac004a02d99"
  credentialsSecret: cloudflared-credentials
  replicas: 2

  image:
    repository: cloudflare/cloudflared
    tag: latest

  resources:
    requests:
      memory: 64Mi
      cpu: 50m
    limits:
      memory: 128Mi
      cpu: 100m

# Note: ArgoCD, Grafana, Prometheus, and other platform services are NOT managed here
# These are deployed separately or via their own Helm charts
# See argocd-config/ directory for manual ArgoCD configuration
