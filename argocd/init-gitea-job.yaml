apiVersion: v1
kind: ConfigMap
metadata:
  name: gitea-init-script
  namespace: argocd
data:
  init.sh: |
    #!/bin/sh
    set -e
    
    echo "=== Initializing Gitea for ArgoCD ==="
    
    # Wait for Gitea API to be ready
    echo "Waiting for Gitea API..."
    i=1
    while [ $i -le 60 ]; do
      if wget -q --spider http://gitea.argocd.svc.cluster.local:3000 2>/dev/null; then
        echo "✅ Gitea is ready"
        break
      fi
      echo "Waiting... ($i/60)"
      i=$((i + 1))
      sleep 5
    done
    
    # Create user and repository via API (skip if exists)
    echo "Creating Gitea admin user..."
    
    # Create admin user
    wget --post-data='{"username":"argocd","password":"argocd-password","email":"argocd@local","must_change_password":false,"send_notify":false}' \
      --header='Content-Type: application/json' \
      -O- \
      http://gitea.argocd.svc.cluster.local:3000/api/v1/admin/users 2>&1 || echo "✓ User already exists"
    
    echo ""
    echo "Creating core-charts repository..."
    
    # Create repository using basic auth
    wget --post-data='{"name":"core-charts","private":false,"auto_init":false,"default_branch":"main"}' \
      --header='Content-Type: application/json' \
      --http-user=argocd \
      --http-password=argocd-password \
      -O- \
      http://gitea.argocd.svc.cluster.local:3000/api/v1/user/repos 2>&1 || echo "✓ Repository already exists"
    
    echo ""
    echo "✅ Gitea initialization complete"
    echo "Repository URL: http://gitea.argocd.svc.cluster.local:3000/argocd/core-charts.git"
    echo ""
    echo "NOTE: Repository is empty. Use port-forward to push from host:"
    echo "  kubectl port-forward -n argocd svc/gitea 3000:3000 &"
    echo "  git push http://argocd:argocd-password@localhost:3000/argocd/core-charts.git main --force"
---
apiVersion: batch/v1
kind: Job
metadata:
  name: gitea-init
  namespace: argocd
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      restartPolicy: OnFailure
      containers:
        - name: git-init
          image: alpine:latest
          command: ["/bin/sh", "/scripts/init.sh"]
          volumeMounts:
            - name: init-script
              mountPath: /scripts
      volumes:
        - name: init-script
          configMap:
            name: gitea-init-script
            defaultMode: 0755
