# NetworkPolicy to allow ArgoCD repo-server to access external Git repositories
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: argocd-repo-server-network-policy
  namespace: argocd
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: argocd-repo-server
  policyTypes:
    - Ingress
    - Egress
  ingress:
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: argocd-server
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: argocd-application-controller
      ports:
        - protocol: TCP
          port: 8081
  egress:
    # Allow DNS to any destination
    - ports:
        - protocol: UDP
          port: 53
    # Allow HTTPS to EXTERNAL IPs (GitHub, etc.)
    - ports:
        - protocol: TCP
          port: 443
      to:
        - ipBlock:
            cidr: 0.0.0.0/0
    # Allow HTTP to external IPs
    - ports:
        - protocol: TCP
          port: 80
      to:
        - ipBlock:
            cidr: 0.0.0.0/0
    # Allow Git protocol
    - ports:
        - protocol: TCP
          port: 9418
      to:
        - ipBlock:
            cidr: 0.0.0.0/0
    # Allow SSH Git
    - ports:
        - protocol: TCP
          port: 22
      to:
        - ipBlock:
            cidr: 0.0.0.0/0
    # Allow internal cluster communication
    - to:
        - podSelector: {}
---
# NetworkPolicy for application-controller (it's a statefulset, not deployment)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: argocd-application-controller-network-policy
  namespace: argocd
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: argocd-application-controller
  policyTypes:
    - Ingress
    - Egress
  ingress:
    - {}
  egress:
    # Allow DNS
    - ports:
        - protocol: UDP
          port: 53
    # Allow HTTPS to external IPs
    - ports:
        - protocol: TCP
          port: 443
      to:
        - ipBlock:
            cidr: 0.0.0.0/0
    # Allow Kubernetes API
    - ports:
        - protocol: TCP
          port: 6443
    # Allow internal cluster communication
    - to:
        - podSelector: {}
