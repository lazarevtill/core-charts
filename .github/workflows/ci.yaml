name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  validate:
    name: Validate Infrastructure
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Helm
        uses: azure/setup-helm@v3
        with:
          version: '3.13.0'

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3

      - name: Lint Helm charts
        run: |
          helm lint charts/infrastructure || true
          helm lint charts/core-pipeline || true

      - name: Validate Kubernetes manifests
        run: |
          kubectl --dry-run=client apply -f argocd-apps/ || true

      - name: Security scan
        run: |
          echo "Scanning for secrets..."
          ! grep -r "password.*=" charts/ || echo "Warning: Found potential hardcoded passwords"

  deploy-staging:
    name: Deploy to Staging (Manual)
    runs-on: ubuntu-latest
    needs: validate
    if: github.event_name == 'pull_request'
    environment: staging
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy notification
        run: |
          echo "Ready to deploy to staging"
          echo "Run: kubectl apply -f argocd-apps/"

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: validate
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Trigger webhook
        run: |
          echo "Production deployment triggered"
          # Webhook will be called by GitHub
